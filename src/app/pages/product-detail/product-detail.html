<!-- Loading Skeleton -->
@if (isLoading()) {
  <div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="animate-pulse">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <div class="h-96 bg-gray-200 rounded-lg"></div>
          <div class="space-y-4">
            <div class="h-8 bg-gray-200 rounded w-3/4"></div>
            <div class="h-4 bg-gray-200 rounded w-1/2"></div>
            <div class="h-20 bg-gray-200 rounded"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
}

<!-- Product Detail -->
@else if (product()) {
  <div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Breadcrumbs -->
      <nav class="mb-6 text-sm">
        <ol class="flex items-center space-x-2 text-gray-600">
          <li><a routerLink="/home" class="hover:text-amber-700">Home</a></li>
          <li><i class="fa-solid fa-chevron-right text-xs"></i></li>
          @if (product()!.category) {
            <li>
              <a
                routerLink="/home"
                [queryParams]="{ category: product()!.category }"
                class="hover:text-amber-700"
                >{{ product()!.category }}</a
              >
            </li>
            <li><i class="fa-solid fa-chevron-right text-xs"></i></li>
          }
          <li class="text-gray-900 font-semibold">{{ product()!.name }}</li>
        </ol>
      </nav>

      <!-- Product Content -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">
        <!-- Left: Image Gallery -->
        <div class="space-y-4">
          <!-- Main Image -->
          <div class="relative bg-white rounded-lg shadow-md overflow-hidden">
            <!-- Stock Badge -->
            <div class="absolute top-4 left-4 z-10">
              @if (product()!.inStock) {
                <span
                  class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold flex items-center space-x-1"
                >
                  <i class="fa-solid fa-circle-check"></i>
                  <span>In Stock</span>
                </span>
              } @else {
                <span
                  class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-xs font-bold flex items-center space-x-1"
                >
                  <i class="fa-solid fa-circle-xmark"></i>
                  <span>Out of Stock</span>
                </span>
              }
            </div>

            <!-- Wishlist Icon (non-functional for now) -->
            <button
              class="absolute top-4 right-4 z-10 bg-white p-2 rounded-full shadow-md hover:bg-gray-50 transition-colors"
            >
              <i class="fa-regular fa-heart text-2xl text-gray-600"></i>
            </button>

            <!-- Main Display Image -->
            <img [src]="mainImage()" [alt]="product()!.name" class="w-full h-96 object-cover" />
          </div>

          <!-- Thumbnail Gallery -->
          <div class="grid grid-cols-4 gap-3">
            @for (image of product()!.images; track $index) {
              <button
                (click)="selectImage(image)"
                [class]="
                  mainImage() === image
                    ? 'border-2 border-amber-600 rounded-lg overflow-hidden'
                    : 'border-2 border-gray-200 rounded-lg overflow-hidden hover:border-amber-400 transition-colors'
                "
              >
                <img
                  [src]="image"
                  [alt]="product()!.name + ' - Image ' + ($index + 1)"
                  class="w-full h-24 object-cover"
                />
              </button>
            }
          </div>
        </div>

        <!-- Right: Product Info -->
        <div class="space-y-6">
          <!-- Brand/Collection & Rating -->
          <div>
            @if (product()!.category) {
              <p class="text-amber-700 font-semibold text-sm uppercase tracking-wide mb-2">
                {{ product()!.category }}
              </p>
            }

            <div class="flex items-center space-x-3 mb-3">
              <app-star-rating [rating]="product()!.rating" [size]="'md'"></app-star-rating>
              <span class="text-gray-600 text-sm">
                {{ product()!.rating }} ({{ product()!.totalReviews }} reviews)
              </span>
            </div>
          </div>

          <!-- Product Name -->
          <h1 class="text-3xl lg:text-4xl font-bold text-gray-900">
            {{ product()!.name }}
          </h1>

          <!-- Price -->
          <div class="flex items-center space-x-3">
            <span class="text-4xl font-bold text-gray-900"> ${{ product()!.price }} </span>
            <span class="text-xl text-gray-500 line-through">
              ${{ getFormerPrice(product()!.price).toFixed(2) }}
            </span>
            <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-sm font-semibold">
              Save 18%
            </span>
          </div>

          <!-- Description -->
          <p class="text-gray-600 leading-relaxed">
            {{ product()!.description }}
          </p>

          <!-- Stock Info -->
          @if (product()!.inStock) {
            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
              <p class="text-green-700 text-sm flex items-center space-x-2">
                <i class="fa-solid fa-truck-fast"></i>
                <span class="font-semibold">In Stock - Ships in 2 days from Lagos</span>
              </p>
              <p class="text-green-600 text-xs mt-1">{{ product()!.stock }} units available</p>
            </div>
          } @else {
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
              <p class="text-red-700 text-sm flex items-center space-x-2">
                <i class="fa-solid fa-circle-exclamation"></i>
                <span class="font-semibold">Currently out of stock</span>
              </p>
            </div>
          }

          <!-- Quantity Selector -->
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Quantity</label>
            <div class="flex items-center space-x-4">
              <div class="flex items-center border-2 border-gray-300 rounded-lg">
                <button
                  (click)="decreaseQuantity()"
                  [disabled]="quantity() <= 1"
                  class="px-4 py-2 text-gray-600 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                >
                  <i class="fa-solid fa-minus"></i>
                </button>
                <span class="px-6 py-2 font-semibold text-gray-900">{{ quantity() }}</span>
                <button
                  (click)="increaseQuantity()"
                  [disabled]="!product()!.inStock || quantity() >= product()!.stock"
                  class="px-4 py-2 text-gray-600 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                >
                  <i class="fa-solid fa-plus"></i>
                </button>
              </div>

              @if (product()!.stock > 0 && product()!.stock <= 10) {
                <span class="text-red-600 text-sm font-semibold">
                  Only {{ product()!.stock }} left in stock!
                </span>
              }
            </div>
          </div>

          <!-- Add to Cart Button -->
          <button
            (click)="addToCart()"
            [disabled]="!product()!.inStock"
            class="w-full bg-amber-600 text-white py-4 px-6 rounded-lg font-semibold text-lg hover:bg-amber-700 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2"
          >
            <i class="fa-solid fa-cart-shopping text-xl"></i>
            <span>{{ isInCart() ? 'Update Cart' : 'Add to Cart' }}</span>
          </button>

          <!-- Additional Info -->
          <div class="border-t pt-6 space-y-3 text-sm text-gray-600">
            <div class="flex items-start space-x-3">
              <i class="fa-solid fa-shield-halved text-amber-600 mt-0.5"></i>
              <span>Secure payment & buyer protection</span>
            </div>
            <div class="flex items-start space-x-3">
              <i class="fa-solid fa-rotate-left text-amber-600 mt-0.5"></i>
              <span>30-day return policy</span>
            </div>
            <div class="flex items-start space-x-3">
              <i class="fa-solid fa-headset text-amber-600 mt-0.5"></i>
              <span>24/7 customer support</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Reviews Section -->
      <div class="mt-16">
        <div class="border-t pt-12">
          <h2 class="text-2xl font-bold text-gray-900 mb-8">Customer Reviews</h2>

          <!-- Desktop: Side by side | Mobile: Stacked -->
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Reviews Summary (1/3 width on desktop) -->
            <div class="lg:col-span-1">
              <div class="bg-white rounded-lg shadow-md p-6 sticky top-4">
                <!-- Overall Rating -->
                <div class="text-center lg:text-left mb-6">
                  <div class="flex items-center justify-center lg:justify-start space-x-2 mb-2">
                    <span class="text-5xl font-bold text-gray-900">{{ product()!.rating }}</span>
                  </div>
                  <app-star-rating [rating]="product()!.rating" [size]="'lg'"></app-star-rating>
                  <p class="text-gray-600 mt-2">Based on {{ product()!.reviews.length }} reviews</p>
                </div>

                <!-- Rating Breakdown -->
                <div class="space-y-2">
                  @for (item of starDistribution(); track item.stars) {
                    <div class="flex items-center space-x-3">
                      <span class="text-sm text-gray-600 w-6">{{ item.stars }}</span>
                      <i class="fa-solid fa-star text-amber-500 text-xs"></i>
                      <div class="flex-1 bg-gray-200 rounded-full h-2">
                        <div
                          class="bg-amber-500 h-2 rounded-full"
                          [style.width.%]="item.percentage"
                        ></div>
                      </div>
                      <span class="text-sm text-gray-600 w-8 text-right">{{ item.count }}</span>
                    </div>
                  }
                </div>
              </div>
            </div>

            <!-- Right Column: Individual Reviews (2/3 width on desktop) -->
            <div class="lg:col-span-2">
              <div class="space-y-6">
                @for (review of product()!.reviews; track review.id) {
                  <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-start justify-between mb-4">
                      <div>
                        <div class="flex items-center space-x-3 mb-2">
                          <div
                            class="w-10 h-10 bg-amber-100 rounded-full flex items-center justify-center"
                          >
                            <span class="text-amber-700 font-semibold">{{
                              getReviewerInitials(review.reviewerName)
                            }}</span>
                          </div>
                          <div>
                            <p class="font-semibold text-gray-900">
                              {{ review.reviewerName }}
                            </p>
                            <p class="text-sm text-gray-500">{{ review.date | relativeTime }}</p>
                          </div>
                        </div>
                        <app-star-rating [rating]="review.rating" [size]="'sm'"></app-star-rating>
                      </div>

                      @if (review.verified) {
                        <span
                          class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-semibold"
                        >
                          <i class="fa-solid fa-circle-check"></i> Verified Purchase
                        </span>
                      }
                    </div>

                    <!-- Review Title -->
                    <h3 class="font-bold text-gray-900 mb-2">{{ review.reviewTitle }}</h3>

                    <!-- Review Comment -->
                    <p class="text-gray-600 leading-relaxed">{{ review.comment }}</p>

                    <div class="flex items-center space-x-6 mt-4 text-sm text-gray-600">
                      <button class="hover:text-amber-600 transition-colors">
                        <i class="fa-regular fa-thumbs-up"></i> Helpful ({{
                          review.helpfulCount || 0
                        }})
                      </button>
                    </div>
                  </div>
                }
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Related Products Section -->
      <div class="mt-16 border-t pt-12">
        <div class="flex items-center justify-between mb-8">
          <h2 class="text-2xl font-bold text-gray-900">You May Also Like</h2>
          <button
            (click)="viewAllInCategory()"
            class="text-amber-700 hover:text-amber-800 font-semibold text-sm flex items-center space-x-1"
          >
            <span>View All</span>
            <i class="fa-solid fa-chevron-right text-xs"></i>
          </button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
          @for (relatedProduct of relatedProducts(); track relatedProduct.id) {
            <app-product-card-component
              [product]="relatedProduct"
              [isSelectedState]="isProductSelected(relatedProduct.id)"
            >
            </app-product-card-component>
          }
        </div>
      </div>
    </div>
  </div>
}

<!-- Error State -->
@else {
  <div class="min-h-screen bg-gray-50 py-8 flex items-center justify-center">
    <div class="text-center">
      <i class="fa-solid fa-circle-exclamation text-6xl text-red-500 mb-4"></i>
      <h2 class="text-2xl font-bold text-gray-900 mb-2">Product Not Found</h2>
      <p class="text-gray-600 mb-6">
        The product you're looking for doesn't exist or has been removed.
      </p>
      <a
        routerLink="/home"
        class="bg-amber-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-amber-700 transition-colors inline-block"
      >
        Back to Home
      </a>
    </div>
  </div>
}
